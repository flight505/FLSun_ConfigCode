#########################################################################
# FLSUN S1 PRO Comprehensive Macro Suite
# Consolidated version including all functionality:
# - Smart filament loading/unloading with sensor management
# - Material-specific settings and print management
# - Enhanced bed leveling with temperature preservation
# - Sensor control and diagnostics
# - Delta-specific optimizations
#########################################################################

#########################################################################
# REQUIRED MODULES
#########################################################################
[respond]

#########################################################################
# CONFIGURATION VARIABLES
#########################################################################
[gcode_macro _SPRO_SETTINGS]
description: Central configuration for all SPRO settings
######################################################################
# Material-specific variables - CUSTOMIZE THESE FOR YOUR SETUP
######################################################################
variable_material_temps: {'PLA': {'hotend': 210, 'bed_inner': 60, 'bed_outer': 55, 'wait_time': 1}, 'PETG': {'hotend': 240, 'bed_inner': 75, 'bed_outer': 70, 'wait_time': 2}, 'ABS': {'hotend': 260, 'bed_inner': 90, 'bed_outer': 85, 'wait_time': 5}, 'ASA': {'hotend': 270, 'bed_inner': 95, 'bed_outer': 90, 'wait_time': 5}, 'TPU': {'hotend': 220, 'bed_inner': 50, 'bed_outer': 45, 'wait_time': 1}, 'PC': {'hotend': 300, 'bed_inner': 110, 'bed_outer': 105, 'wait_time': 8}}
variable_z_offsets: {'PLA': 0.0, 'PETG': 0.02, 'ABS': 0.05, 'ASA': 0.05, 'TPU': -0.02, 'PC': 0.08}

# S1 PRO performance settings
variable_max_velocity: 1200
variable_max_accel: 40000
variable_print_accel: 20000  # Conservative for quality
variable_travel_accel: 30000
variable_max_flow_rate: 110
gcode:

#########################################################################
# FILAMENT LOADING/UNLOADING WITH SENSOR MANAGEMENT
#########################################################################

[gcode_macro SMART_UNLOAD]
description: Intelligent filament unloading - retracts from extruder only (no sensor interaction)
gcode:
    {% set extruder_temp = params.TEMP|default(235)|int %}
    {% set current_target_temp  = printer.extruder.target|int %}
    {% set speed_factor = printer.gcode_move.speed_factor|float %}
    {% set extrude_factor = printer.gcode_move.extrude_factor|float %}

    {% if printer.print_stats.state != "printing" %}
        # Disable sensors during unloading
        SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0
        SET_FILAMENT_SENSOR SENSOR=my_sensor ENABLE=0
        RESPOND MSG="Sensors temporarily disabled for unloading process"
        
        # Temperature management based on printer state
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Heating nozzle for unload...
            {action_respond_info("Heating nozzle to unload temperature...")}
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Heating nozzle for unload...
                {action_respond_info("Heating nozzle to unload temperature...")}
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Maintaining current temperature...
                {action_respond_info("Using current nozzle temperature for unload...")}
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
        
        M117 Unloading filament...
        G91  # Relative positioning
        M220 S100    # Reset speed factor
        M221 S100    # Reset extrude factor
        
        # Enhanced multi-stage unloading with tip forming to prevent jamming
        RESPOND MSG="Stage 1: Tip forming - small extrusion"
        G1 E2 F300     # Small push (2mm @ 5mm/s) to prevent stringing
        G1 E-2 F2100   # Quick retract (2mm @ 35mm/s)
        RESPOND MSG="Stage 2: Cooling moves - shape the tip"
        G1 E-5 F1200   # Retract (5mm @ 20mm/s)
        G1 E2 F1200    # Push back (2mm @ 20mm/s) to form tip
        G1 E-5 F1500   # Retract (5mm @ 25mm/s)
        RESPOND MSG="Stage 3: Clear hotend"
        G1 E-10 F1800  # Clear hotend (10mm @ 30mm/s)
        RESPOND MSG="Stage 4: Final fast retract"
        G1 E-10 F3000  # Fast retract (10mm @ 50mm/s) - away from gears
        M400    
        
        # Restore settings
        M220 S{speed_factor*100}  
        M221 S{extrude_factor*100}
        G90  # Absolute positioning
        SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
        M400
        M117 Unload complete!
        
        # Temperature management after unload
        {% if current_target_temp == 0 or printer.print_stats.state != "paused"%}
            M104 S0
        {% endif %}
        RESPOND MSG="Filament unloaded from extruder. Remove filament from guide tube."
        RESPOND MSG="IMPORTANT: Run ENABLE_SENSORS before printing!"
    {% else %}
        {action_respond_info("Cannot unload filament while printing!")}
        M117 Cannot unload while printing!
    {% endif %}

[gcode_macro SMART_LOAD]
description: Intelligent filament loading with automatic sensor management
gcode:
    {% set extruder_temp = params.TEMP|default(220)|int %}
    {% set speed_factor = printer.gcode_move.speed_factor|float %}
    {% set extrude_factor = printer.gcode_move.extrude_factor|float %}

    # CRITICAL: Disable sensors during loading as filament passes through them
    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0
    SET_FILAMENT_SENSOR SENSOR=my_sensor ENABLE=0
    RESPOND MSG="Sensors temporarily disabled for loading process"

    {% if printer.print_stats.state != "printing" %}
        # Heat extruder if needed
        {% if printer.extruder.temperature < extruder_temp - 5 %}
            M104 S{extruder_temp}
            M117 Heating for filament load...
            RESPOND MSG="Heating to {extruder_temp}°C for loading"
            M109 S{extruder_temp}
        {% endif %}
        
        M117 Loading filament...
        G91  # Relative positioning
        M220 S100    # Reset speed factor
        M221 S100    # Reset extrude factor
        
        # Multi-stage loading sequence optimized for direct drive
        RESPOND MSG="Stage 1: Initial feed"
        G1 E10 F300   # Slow initial feed (10mm @ 5mm/s)
        RESPOND MSG="Stage 2: Prime extruder"
        G1 E15 F600   # Prime extruder (15mm @ 10mm/s)
        RESPOND MSG="Stage 3: Final extrusion"
        G1 E5 F150    # Final slow extrusion (5mm @ 2.5mm/s)
        M400
        
        # Restore settings
        M220 S{speed_factor*100}
        M221 S{extrude_factor*100}
        G90  # Absolute positioning
        M400
        SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
        
        M117 Load complete - Enable sensors!
        RESPOND MSG="Filament loaded successfully!"
        RESPOND MSG="IMPORTANT: Run ENABLE_SENSORS before printing!"
    {% else %}
        {action_respond_info("Cannot load filament while printing!")}
        M117 Cannot load while printing!
    {% endif %}

#########################################################################
# SENSOR MANAGEMENT
#########################################################################

[gcode_macro ENABLE_SENSORS]
description: Enable all filament sensors for printing
gcode:
    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
    SET_FILAMENT_SENSOR SENSOR=my_sensor ENABLE=1
    RESPOND MSG="All filament sensors ENABLED and ready for printing"
    
    # Check and report sensor status
    {% if 'filament_switch_sensor filament_sensor' in printer %}
        {% set switch_status = printer['filament_switch_sensor filament_sensor'].filament_detected %}
        RESPOND MSG="Runout sensor: {'FILAMENT DETECTED' if switch_status else 'NO FILAMENT'}"
    {% endif %}
    
    {% if 'filament_motion_sensor my_sensor' in printer %}
        {% set motion_status = printer['filament_motion_sensor my_sensor'].filament_detected %}
        RESPOND MSG="Motion sensor: {'READY' if motion_status else 'NOT READY'}"
    {% endif %}

[gcode_macro DISABLE_SENSORS]
description: Disable all filament sensors for maintenance
gcode:
    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0
    SET_FILAMENT_SENSOR SENSOR=my_sensor ENABLE=0
    RESPOND MSG="All filament sensors DISABLED for maintenance"

[gcode_macro SENSOR_STATUS]
description: Detailed filament sensor diagnostic report
gcode:
    RESPOND MSG="=== FILAMENT SENSOR STATUS ==="
    
    # Runout sensor status
    {% if 'filament_switch_sensor filament_sensor' in printer %}
        {% set switch_status = printer['filament_switch_sensor filament_sensor'].filament_detected %}
        {% set switch_enabled = printer['filament_switch_sensor filament_sensor'].enabled %}
        RESPOND MSG="Runout Sensor:"
        RESPOND MSG="   • State: {'ENABLED' if switch_enabled else 'DISABLED'}"
        RESPOND MSG="   • Filament: {'DETECTED' if switch_status else 'NOT DETECTED'}"
        RESPOND MSG="   • Pin: PA11"
    {% else %}
        RESPOND MSG="Runout sensor: NOT CONFIGURED"
    {% endif %}
    
    # Motion sensor status
    {% if 'filament_motion_sensor my_sensor' in printer %}
        {% set motion_status = printer['filament_motion_sensor my_sensor'].filament_detected %}
        {% set motion_enabled = printer['filament_motion_sensor my_sensor'].enabled %}
        RESPOND MSG="Motion Sensor (Clog Detection):"
        RESPOND MSG="   • State: {'ENABLED' if motion_enabled else 'DISABLED'}"
        RESPOND MSG="   • Status: {'ACTIVE' if motion_status else 'INACTIVE'}"
        RESPOND MSG="   • Pin: PA10"
        RESPOND MSG="   • Detection Length: 18mm"
    {% else %}
        RESPOND MSG="Motion sensor: NOT CONFIGURED"
    {% endif %}
    
    RESPOND MSG="================================="

#########################################################################
# ENHANCED BED LEVELING WITH TEMPERATURE PRESERVATION
#########################################################################

[gcode_macro BED_LEVEL_1]
description: Delta calibration with automatic temperature preservation
rename_existing: BED_LEVEL_1_BASE
gcode:
    {% set nozzle_temp = printer.extruder.target|float %}
    {% set bed_temp = printer.heater_bed.target|float %}

    # Save current temperatures
    SAVE_VARIABLE VARIABLE=nozzle_temp VALUE={nozzle_temp}
    SAVE_VARIABLE VARIABLE=bed_temp VALUE={bed_temp}

    RESPOND MSG="Saved temperatures - Nozzle: {nozzle_temp|round(1)}°C, Bed: {bed_temp|round(1)}°C"
    
    # Level sequence
    SET_GCODE_OFFSET Z=0
    M117 Delta Calibration Starting
    G28
    M204 S200  # Set low acceleration for accuracy
    
    # Heat to standard calibration temps
    M104 S140
    M140 S60
    M109 S140
    M190 S60
    
    RESPOND MSG="Running delta calibration..."
    DELTA_CALIBRATE
    
    G1 X0 Y0 Z50 F4200
    M104 S0
    M140 S0
    G28
    
    SAVE_VARIABLE VARIABLE=level_state VALUE=True
    RESPOND MSG="Delta calibration complete!"

[gcode_macro BED_LEVEL_2]
description: Bed mesh calibration with temperature restoration
rename_existing: BED_LEVEL_2_BASE
gcode:
    M117 Mesh Calibration Starting
    G28

    # Restore saved temperatures
    {% set svv = printer.save_variables.variables %}
    {% set nozzle_temp = svv.nozzle_temp|default(0)|float %}
    {% set bed_temp = svv.bed_temp|default(0)|float %}

    RESPOND MSG="Restoring temperatures - Nozzle: {nozzle_temp|round(1)}°C, Bed: {bed_temp|round(1)}°C"

    # Heat to saved temps
    M104 S{nozzle_temp}
    M140 S{bed_temp}
    M109 S{nozzle_temp}
    M190 S{bed_temp}

    RESPOND MSG="Creating bed mesh..."
    G1 X0 Y0 Z50 F4200
    BED_MESH_CALIBRATE
    G1 X0 Y0 Z50 F4200
    G28

    SAVE_VARIABLE VARIABLE=level2_state VALUE=True
    RESPOND MSG="Bed mesh calibration complete!"

#########################################################################
# PRINT START/END SEQUENCES
#########################################################################

[gcode_macro SPRO_PRINT_START]
description: Comprehensive print start sequence with all optimizations
gcode:
    {% set BED_TEMP = params.BED|default(60)|int %}
    {% set EXTRUDER_TEMP = params.EXTRUDER|default(210)|int %}
    {% set MATERIAL = params.MATERIAL|default('PLA')|upper %}
    
    RESPOND MSG="SPRO Print Start: {MATERIAL} @ {EXTRUDER_TEMP}°C/{BED_TEMP}°C"
    
    # Initialize printer state
    CLEAR_PAUSE
    G21  # Metric
    M82  # Absolute extrusion
    G90  # Absolute positioning
    
    # Enable sensors for printing
    ENABLE_SENSORS
    
    # Home if needed
    {% if not 'xyz' in printer.toolhead.homed_axes %}
        G28
        RESPOND MSG="Homing complete"
    {% endif %}
    
    # Set performance limits
    SET_VELOCITY_LIMIT VELOCITY={printer["gcode_macro _SPRO_SETTINGS"].max_velocity}
    SET_VELOCITY_LIMIT ACCEL={printer["gcode_macro _SPRO_SETTINGS"].travel_accel}
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=5
    
    # Heat bed with smart zones
    SPRO_HEAT_ZONES MATERIAL={MATERIAL}
    
    # Material-specific heat soak
    {% set settings = printer["gcode_macro _SPRO_SETTINGS"].material_temps %}
    {% if MATERIAL in settings %}
        {% set wait_minutes = settings[MATERIAL].wait_time %}
        RESPOND MSG="Heat soaking for {wait_minutes} minutes..."
        WAIT_FOR WAIT_TIME={wait_minutes * 60}
    {% endif %}
    
    # Load temperature-specific mesh
    SPRO_MESH_MANAGER BED_TEMP={BED_TEMP}
    
    # Heat extruder and apply material settings
    M104 S{EXTRUDER_TEMP}
    SPRO_MATERIAL_SETTINGS MATERIAL={MATERIAL}
    M109 S{EXTRUDER_TEMP}
    
    # Prime line
    SPRO_PRIME_LINE
    
    # Set printing acceleration
    SET_VELOCITY_LIMIT ACCEL={printer["gcode_macro _SPRO_SETTINGS"].print_accel}
    
    RESPOND MSG="SPRO ready to print!"

[gcode_macro SPRO_PRINT_END]
description: Comprehensive print end sequence
gcode:
    RESPOND MSG="SPRO Print End"
    
    # Retract and lift
    G91  # Relative
    G1 E-5 F3600    # Quick retract
    G1 E-10 F1800   # Slow retract from melt zone
    G1 Z5 F3000     # Lift nozzle
    G90  # Absolute
    
    # Home and shutdown
    G28
    M104 S0  # Extruder off
    M140 S0  # Bed off
    M107     # Fan off
    
    # Disable steppers after delay
    M84 S600  # Disable steppers after 10 minutes
    
    # Reset to safe settings
    SET_VELOCITY_LIMIT ACCEL=10000
    
    RESPOND MSG="Print complete! Thank you for using SPRO."

#########################################################################
# MATERIAL AND TEMPERATURE MANAGEMENT
#########################################################################

[gcode_macro SPRO_HEAT_ZONES]
description: Smart dual-zone heating for S1 PRO
gcode:
    {% set MATERIAL = params.MATERIAL|default('PLA')|upper %}
    {% set settings = printer["gcode_macro _SPRO_SETTINGS"].material_temps %}
    
    {% if MATERIAL in settings %}
        {% set inner_temp = settings[MATERIAL].bed_inner %}
        {% set outer_temp = settings[MATERIAL].bed_outer %}
        
        RESPOND MSG="Heating zones for {MATERIAL}: Inner={inner_temp}°C, Outer={outer_temp}°C"
        
        # Heat both zones
        M140 S{inner_temp}  # Inner bed
        SET_HEATER_TEMPERATURE HEATER=HotBed1 TARGET={outer_temp}  # Outer bed zone
        
        # Wait for both zones to reach temperature
        M190 S{inner_temp}
        TEMPERATURE_WAIT SENSOR="heater_generic HotBed1" MINIMUM={outer_temp - 2}
        
    {% else %}
        RESPOND MSG="Unknown material: {MATERIAL}, using PLA defaults"
        M140 S60
        SET_HEATER_TEMPERATURE HEATER=HotBed1 TARGET=55
        M190 S60
        TEMPERATURE_WAIT SENSOR="heater_generic HotBed1" MINIMUM=53
    {% endif %}

[gcode_macro SPRO_MATERIAL_SETTINGS]
description: Apply material-specific settings and offsets
gcode:
    {% set MATERIAL = params.MATERIAL|default('PLA')|upper %}
    {% set settings = printer["gcode_macro _SPRO_SETTINGS"].material_temps %}
    {% set offsets = printer["gcode_macro _SPRO_SETTINGS"].z_offsets %}
    
    {% if MATERIAL in settings %}
        # Apply Z offset for material
        {% if MATERIAL in offsets %}
            SET_GCODE_OFFSET Z={offsets[MATERIAL]}
            RESPOND MSG="Z offset for {MATERIAL}: {offsets[MATERIAL]}mm"
        {% endif %}
        
        # Set performance based on material characteristics
        {% if MATERIAL in ['ABS', 'ASA', 'PC'] %}
            # High-temp materials: more conservative settings
            SET_VELOCITY_LIMIT ACCEL={printer["gcode_macro _SPRO_SETTINGS"].print_accel}
            RESPOND MSG="Using conservative acceleration for {MATERIAL}"
        {% else %}
            # Standard materials: full performance
            SET_VELOCITY_LIMIT ACCEL={printer["gcode_macro _SPRO_SETTINGS"].max_accel}
            RESPOND MSG="Using maximum performance for {MATERIAL}"
        {% endif %}
    {% endif %}

[gcode_macro SPRO_MESH_MANAGER]
description: Temperature-based mesh management
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|int %}
    {% set PROFILE_NAME = 's1pro_' + BED_TEMP|string + 'c' %}
    
    RESPOND MSG="Checking for mesh profile: {PROFILE_NAME}"
    
    {% if PROFILE_NAME in printer.bed_mesh.profiles %}
        BED_MESH_PROFILE LOAD={PROFILE_NAME}
        RESPOND MSG="Loaded existing mesh: {PROFILE_NAME}"
    {% else %}
        RESPOND MSG="Creating new mesh for {BED_TEMP}°C..."
        BED_MESH_CALIBRATE PROFILE={PROFILE_NAME}
        BED_MESH_PROFILE SAVE={PROFILE_NAME}
        RESPOND MSG="Saved new mesh: {PROFILE_NAME}"
    {% endif %}

#########################################################################
# PRIME LINE AND UTILITIES
#########################################################################

[gcode_macro SPRO_PRIME_LINE]
description: Draw optimized prime line for S1 PRO delta geometry
gcode:
    RESPOND MSG="Drawing SPRO prime line"
    
    # Move to safe prime position (within 160mm radius)
    G1 Z5 F3000
    G1 X0 Y-145 Z0.4 F6000  # Safe position for 320mm diameter
    
    # Prime sequence
    M107  # Fan off during prime
    G92 E0
    G1 X25 Y-145 Z0.3 E8 F1000   # Initial extrusion
    G1 X50 Y-140 Z0.3 E16 F1200  # Medium speed
    G1 X75 Y-135 Z0.3 E26 F1500  # Faster for longer line
    G1 Z2 F2000  # Lift
    G92 E0
    
    RESPOND MSG="Prime line complete"

[gcode_macro WAIT_FOR]
description: Wait for specified time with progress updates
gcode:
    {% set wait_time = params.WAIT_TIME|default(60)|int %}
    {% set interval = 30 %}
    {% set loops = wait_time // interval %}
    {% set remainder = wait_time % interval %}

    RESPOND MSG="Waiting {wait_time} seconds..."

    {% for i in range(loops) %}
        {% set remaining = wait_time - (i * interval) %}
        {% set minutes = remaining // 60 %}
        {% set seconds = remaining % 60 %}
        RESPOND MSG="{minutes}m {seconds}s remaining..."
        G4 P{interval * 1000}
    {% endfor %}

    {% if remainder > 0 %}
        G4 P{remainder * 1000}
    {% endif %}

    RESPOND MSG="Wait complete"

#########################################################################
# MAINTENANCE AND CALIBRATION
#########################################################################
#
# TEMPERATURE OPTIMIZATION NOTES:
# - Cooling targets optimized to prevent long waits (20-40 minutes)
# - Bed cooling: 50°C (was 40°C) - saves ~10 minutes, safe for movement
# - Hotend cooling: 60°C (was 50°C) - saves ~8 minutes, safe for homing
# - These temperatures are well above ambient and safe for all operations
# - Total time savings: ~23 minutes from full calibration sequence
#

[gcode_macro SPRO_PID_HOTEND]
description: Hotend PID Calibration without SAVE_CONFIG (for use in full calibration)
gcode:
    {% set HOTEND_TEMP=params.HOTEND_TEMP|default(240)|float %}
    {% if printer.print_stats.state == "printing" %}
      RESPOND MSG="This macro cannot be used while printing!"
    {% else %}
      RESPOND MSG="Hotend PID calibration starting at {HOTEND_TEMP}°C..."
      SCREEN_LED_ON R=0 O=0 W=1
      {% if printer.toolhead.homed_axes != "xyz" %}
        G28
      {% endif %}
      G90
      G1 Z50 F6000
      M400
      M106 S255
      RESPOND MSG="Running PID_CALIBRATE for hotend - this takes ~5 minutes"
      PID_CALIBRATE HEATER=extruder TARGET={HOTEND_TEMP}
      M400  # Ensure PID calibration is complete
      # Cool down hotend before next stage
      M104 S0
      RESPOND MSG="Hotend PID complete - activating cooling..."
      # Use both fans for faster cooling
      M106 S255
      SET_FAN_SPEED FAN=box_fan SPEED=1.0
      TEMPERATURE_WAIT SENSOR=extruder MAXIMUM=60  # Raised from 50°C - saves ~8 minutes, still safe for homing
      # Turn off fans
      M107
      SET_FAN_SPEED FAN=box_fan SPEED=0
      RESPOND MSG="Hotend cool-down complete"
      G28
      SCREEN_LED_ON R=0 O=0 W=1
      RESPOND MSG="Hotend PID calibration finished - values calculated but not saved"
      M400
      # Note: SAVE_CONFIG is NOT called here - will be done at end of full calibration
    {% endif %}

[gcode_macro SPRO_PID_BED]
description: Bed PID Calibration without SAVE_CONFIG (for use in full calibration)
gcode:
    {% set BED_TEMP=params.BED_TEMP|default(60)|float %}
    {% if printer.print_stats.state == "printing" %}
      RESPOND MSG="This macro cannot be used while printing!"
    {% else %}
      RESPOND MSG="BED PID CALIBRATION START at {BED_TEMP}°C!"
      SCREEN_LED_ON R=0 O=0 W=1
      {% if printer.toolhead.homed_axes != "xyz" %}
        G28
      {% endif %}
      G90
      G1 Z50 F6000
      M400
      M106 S255
      RESPOND MSG="PID Calibration for inner bed zone - this takes ~5-7 minutes"
      PID_CALIBRATE HEATER=heater_bed TARGET={BED_TEMP}
      M400  # Ensure inner bed PID is complete
      RESPOND MSG="Inner bed complete. Starting outer bed zone PID calibration..."
      PID_CALIBRATE HEATER=HotBed1 TARGET={BED_TEMP}
      M400  # Ensure outer bed PID is complete
      # Cool down beds before next stage
      M140 S0
      SET_HEATER_TEMPERATURE HEATER=HotBed1 TARGET=0
      RESPOND MSG="Bed PID complete - activating chamber cooling..."
      # Keep part cooling fan for airflow
      M106 S255
      # Activate chamber fan for maximum cooling
      SET_FAN_SPEED FAN=box_fan SPEED=1.0
      TEMPERATURE_WAIT SENSOR=heater_bed MAXIMUM=50  # Raised from 40°C - saves ~10 minutes, still safe
      TEMPERATURE_WAIT SENSOR="heater_generic HotBed1" MAXIMUM=50  # Raised from 40°C - saves ~10 minutes, still safe
      # Turn off cooling fans
      M107
      SET_FAN_SPEED FAN=box_fan SPEED=0
      RESPOND MSG="Cool-down complete, fans off"
      G28
      SCREEN_LED_ON R=0 O=0 W=1
      RESPOND MSG="Bed PID calibration finished - values calculated but not saved"
      M400
      # Note: SAVE_CONFIG is NOT called here - will be done at end of full calibration
    {% endif %}

[gcode_macro SPRO_MAINTENANCE_MODE]
description: Enter safe maintenance mode
gcode:
    RESPOND MSG="Entering SPRO Maintenance Mode"
    
    # Disable all sensors
    DISABLE_SENSORS
    
    # Turn off heaters
    M104 S0
    M140 S0
    
    # Set conservative motion limits
    SET_VELOCITY_LIMIT VELOCITY=100
    SET_VELOCITY_LIMIT ACCEL=1000
    
    # Disable extruder
    SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
    
    RESPOND MSG="Maintenance mode active. Safe for manual operations."

[gcode_macro SPRO_MEASURING_RESONANCES]
description: Measuring Resonances without SAVE_CONFIG (for use in full calibration)
gcode:
    RESPOND MSG="MEASURING RESONANCES START!"
    SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
    G28
    SHAPER_CALIBRATE
    M400  # Wait for all moves to complete
    G28
    RESPOND MSG="Resonance measurement complete - values calculated but not saved"
    # Note: SAVE_CONFIG is NOT called here - will be done at end of full calibration

[gcode_macro SPRO_MOTOR_CALIBRATION]
description: Motor calibration with better messaging
gcode:
    RESPOND MSG="Starting motor calibration..."
    G28
    G90
    G1 Z10 F6000
    M400
    RESPOND MSG="Cleaning motor calibration data..."
    CLEAN_CALIBRATE_MOTOR
    M400
    RESPOND MSG="Motor calibration in progress (30 seconds)..."
    RESPOND MSG="Note: 'please calibrate motor' messages are normal during this process"
    CALIBRATE_MOTOR_DATA
    M400
    # The motor calibration process itself outputs messages
    # We just need to wait for it to complete
    RESPOND MSG="All motors calibrated successfully"
    G28
    M400
    RESPOND MSG="Motor calibration complete!"

[gcode_macro SPRO_FULL_CALIBRATION]
description: Complete calibration sequence for S1 PRO - ALL calibrations
gcode:
    RESPOND MSG="Starting SPRO Complete Calibration Sequence"
    RESPOND MSG="This will take approximately 60-90 minutes"
    RESPOND MSG="DO NOT turn off printer or restart Klipper until complete!"
    RESPOND MSG="Run CHECK_CALIBRATION_STATUS to monitor progress"
    
    # Check if calibration was previously interrupted
    {% if printer.save_variables.variables.calibration_in_progress|default(False) %}
        {% set stage = printer.save_variables.variables.calibration_stage|default(0)|int %}
        RESPOND MSG="WARNING: Previous calibration interrupted at stage {stage}"
        RESPOND MSG="Restarting from beginning..."
    {% endif %}
    
    # Save initial state
    {% set initial_extruder_temp = printer.extruder.target|float %}
    {% set initial_bed_temp = printer.heater_bed.target|float %}
    
    # Initialize calibration state
    SAVE_VARIABLE VARIABLE=calibration_stage VALUE=0
    SAVE_VARIABLE VARIABLE=calibration_in_progress VALUE=True
    
    # Stage 1: Motor calibration
    RESPOND MSG="========== Stage 1/6: Motor Calibration =========="
    SAVE_VARIABLE VARIABLE=calibration_stage VALUE=1
    SPRO_MOTOR_CALIBRATION
    RESPOND MSG="Stage 1 complete - Motor calibration finished"
    G4 P2000  # 2 second pause between stages
    
    # Stage 2: Delta calibration (MUST be done before bed mesh)
    RESPOND MSG="========== Stage 2/6: Delta Calibration =========="
    RESPOND MSG="This will take approximately 5 minutes"
    RESPOND MSG="Critical: Establishes delta geometry before any probing"
    SAVE_VARIABLE VARIABLE=calibration_stage VALUE=2
    G28
    DELTA_CALIBRATE
    M400
    RESPOND MSG="Stage 2 complete - Delta geometry calculated"
    G4 P2000  # 2 second pause between stages
    
    # Stage 3: PID Calibration for hotend
    RESPOND MSG="========== Stage 3/6: Hotend PID Calibration =========="
    RESPOND MSG="This will take approximately 5 minutes"
    SAVE_VARIABLE VARIABLE=calibration_stage VALUE=3
    SPRO_PID_HOTEND HOTEND_TEMP=240
    RESPOND MSG="Stage 3 complete - Hotend PID values calculated"
    G4 P2000  # 2 second pause between stages
    
    # Stage 4: PID Calibration for bed (both zones)
    RESPOND MSG="========== Stage 4/6: Bed PID Calibration (both zones) =========="
    RESPOND MSG="This will take approximately 10-15 minutes"
    SAVE_VARIABLE VARIABLE=calibration_stage VALUE=4
    SPRO_PID_BED BED_TEMP=60
    RESPOND MSG="Stage 4 complete - Bed PID values calculated for both zones"
    G4 P2000  # 2 second pause between stages
    
    # Stage 5: Input shaper calibration
    RESPOND MSG="========== Stage 5/6: Resonance/Input Shaper Calibration =========="
    RESPOND MSG="This will take approximately 5 minutes"
    SAVE_VARIABLE VARIABLE=calibration_stage VALUE=5
    SPRO_MEASURING_RESONANCES
    RESPOND MSG="Stage 5 complete - Input shaper values calculated"
    G4 P2000  # 2 second pause between stages
    
    # Stage 6: Create temperature mesh profiles
    RESPOND MSG="========== Stage 6/6: Bed Mesh Calibration (multiple temperatures) =========="
    RESPOND MSG="This will take approximately 20-25 minutes"
    SAVE_VARIABLE VARIABLE=calibration_stage VALUE=6
    {% for temp in [60, 70, 80, 90, 100] %}
        RESPOND MSG="Creating mesh for {temp}°C (includes 2 minute heat soak)"
        M140 S{temp}
        M190 S{temp}
        WAIT_FOR WAIT_TIME=120  # 2 minute heat soak
        BED_MESH_CALIBRATE PROFILE=s1pro_{temp}c
        BED_MESH_PROFILE SAVE=s1pro_{temp}c
        RESPOND MSG="Mesh for {temp}°C complete"
    {% endfor %}
    
    # Cool down with active cooling
    RESPOND MSG="Cooling down with chamber fan..."
    M140 S0
    M141 S0
    M104 S0
    # Use active cooling for faster cool-down
    M106 S255
    SET_FAN_SPEED FAN=box_fan SPEED=1.0
    TEMPERATURE_WAIT SENSOR=heater_bed MAXIMUM=50  # Reduced from 30°C - saves time, still safe
    M107
    SET_FAN_SPEED FAN=box_fan SPEED=0
    G28
    G90  # Absolute positioning
    G1 X0 Y0 Z50 F6000  # Move to center, 50mm above bed
    
    RESPOND MSG="============================================="
    RESPOND MSG="SPRO FULL CALIBRATION COMPLETE!"
    RESPOND MSG="============================================="
    RESPOND MSG="Calibrations performed (optimized order):"
    RESPOND MSG="  ✓ Motor calibration"
    RESPOND MSG="  ✓ Delta calibration (geometry established)"
    RESPOND MSG="  ✓ Hotend PID tuning (240°C)"
    RESPOND MSG="  ✓ Dual-zone bed PID tuning (60°C)"
    RESPOND MSG="  ✓ Input shaper/resonance testing"
    RESPOND MSG="  ✓ Bed meshes for 60°C, 70°C, 80°C, 90°C, 100°C"
    RESPOND MSG="============================================="
    RESPOND MSG="Saving all calibration data and restarting Klipper..."
    # Clear calibration state
    SAVE_VARIABLE VARIABLE=calibration_stage VALUE=0
    SAVE_VARIABLE VARIABLE=calibration_in_progress VALUE=False
    # Save all calibration results
    SAVE_CONFIG

#########################################################################
# MATERIAL-SPECIFIC LOAD/UNLOAD MACROS
#########################################################################

[gcode_macro LOAD_PLA]
description: Load PLA filament with optimal temperature
gcode:
    SMART_LOAD TEMP=210

[gcode_macro UNLOAD_PLA]
description: Unload PLA filament with optimal temperature
gcode:
    SMART_UNLOAD TEMP=210

[gcode_macro LOAD_PETG]
description: Load PETG filament with optimal temperature
gcode:
    SMART_LOAD TEMP=240

[gcode_macro UNLOAD_PETG]
description: Unload PETG filament with optimal temperature
gcode:
    SMART_UNLOAD TEMP=240

[gcode_macro LOAD_ABS]
description: Load ABS filament with optimal temperature
gcode:
    SMART_LOAD TEMP=260

[gcode_macro UNLOAD_ABS]
description: Unload ABS filament with optimal temperature
gcode:
    SMART_UNLOAD TEMP=260

[gcode_macro LOAD_ASA]
description: Load ASA filament with optimal temperature
gcode:
    SMART_LOAD TEMP=270

[gcode_macro UNLOAD_ASA]
description: Unload ASA filament with optimal temperature
gcode:
    SMART_UNLOAD TEMP=270

[gcode_macro LOAD_TPU]
description: Load TPU filament with optimal temperature and slower speeds
gcode:
    SMART_LOAD TEMP=220

[gcode_macro UNLOAD_TPU]
description: Unload TPU filament with optimal temperature
gcode:
    SMART_UNLOAD TEMP=220

[gcode_macro LOAD_PC]
description: Load PC filament with optimal temperature
gcode:
    SMART_LOAD TEMP=300

[gcode_macro UNLOAD_PC]
description: Unload PC filament with optimal temperature
gcode:
    SMART_UNLOAD TEMP=300

#########################################################################
# CALIBRATION TEST AND DEBUG MACROS
#########################################################################

[gcode_macro CHECK_CALIBRATION_STATUS]
description: Check the current calibration progress
gcode:
    {% if printer.save_variables.variables.calibration_in_progress|default(False) %}
        {% set stage = printer.save_variables.variables.calibration_stage|default(0)|int %}
        RESPOND MSG="Calibration in progress: Stage {stage}/6"
        {% if stage == 1 %}
            RESPOND MSG="Currently: Motor calibration"
        {% elif stage == 2 %}
            RESPOND MSG="Currently: Hotend PID calibration"
        {% elif stage == 3 %}
            RESPOND MSG="Currently: Bed PID calibration"
        {% elif stage == 4 %}
            RESPOND MSG="Currently: Input shaper calibration"
        {% elif stage == 5 %}
            RESPOND MSG="Currently: Delta calibration"
        {% elif stage == 6 %}
            RESPOND MSG="Currently: Bed mesh calibration"
        {% endif %}
    {% else %}
        RESPOND MSG="No calibration in progress"
    {% endif %}

[gcode_macro RESET_CALIBRATION_STATE]
description: Reset calibration state if stuck
gcode:
    SAVE_VARIABLE VARIABLE=calibration_stage VALUE=0
    SAVE_VARIABLE VARIABLE=calibration_in_progress VALUE=False
    RESPOND MSG="Calibration state reset"

[gcode_macro TEST_PID_NO_SAVE]
description: Test PID calibration without save to verify it doesn't restart
gcode:
    RESPOND MSG="Testing PID calibration without SAVE_CONFIG..."
    RESPOND MSG="Starting hotend PID at 200°C (shorter test)"
    {% if printer.toolhead.homed_axes != "xyz" %}
        G28
    {% endif %}
    G90
    G1 Z50 F6000
    M106 S255
    PID_CALIBRATE HEATER=extruder TARGET=200
    M107
    RESPOND MSG="PID calibration complete - Klipper should NOT restart"
    RESPOND MSG="If you see this message, the test passed!"
    RESPOND MSG="PID values were calculated but not saved"

[gcode_macro RUN_INDIVIDUAL_CALIBRATIONS]
description: Run calibrations individually with manual save
gcode:
    RESPOND MSG="This will run each calibration with SAVE_CONFIG"
    RESPOND MSG="Use this if SPRO_FULL_CALIBRATION fails"
    RESPOND MSG="Run these commands one at a time:"
    RESPOND MSG="1. CALIBRATE_MOTOR"
    RESPOND MSG="2. PID_HOTEND HOTEND_TEMP=240"
    RESPOND MSG="3. PID_BED BED_TEMP=60"
    RESPOND MSG="4. MEASURING_RESONANCES"
    RESPOND MSG="5. DELTA_CALIBRATE + SAVE_CONFIG"
    RESPOND MSG="6. Run bed mesh manually"

#########################################################################
# QUICK ACCESS MACROS
#########################################################################

[gcode_macro LOAD]
description: Quick filament load (alias for SMART_LOAD)
gcode:
    SMART_LOAD TEMP={params.TEMP|default(220)}

[gcode_macro UNLOAD]
description: Quick filament unload (alias for SMART_UNLOAD)
gcode:
    SMART_UNLOAD TEMP={params.TEMP|default(235)}

[gcode_macro CHECK_SENSORS]
description: Quick sensor check (alias for SENSOR_STATUS)
gcode:
    SENSOR_STATUS

#########################################################################
# DUAL ZONE BED CONTROL
#########################################################################

[gcode_macro M141]
description: Set outer bed temperature (S = target temp)
gcode:
    {% set temp = params.S|default(0)|int %}
    SET_HEATER_TEMPERATURE HEATER=HotBed1 TARGET={temp}
    
[gcode_macro M191]
description: Wait for outer bed temperature (S = target temp)
gcode:
    {% set temp = params.S|default(0)|int %}
    SET_HEATER_TEMPERATURE HEATER=HotBed1 TARGET={temp}
    TEMPERATURE_WAIT SENSOR="heater_generic HotBed1" MINIMUM={temp - 2}

[gcode_macro BED_TEMPS]
description: Set both bed zones (INNER= OUTER=)
gcode:
    {% set inner = params.INNER|default(60)|int %}
    {% set outer = params.OUTER|default(55)|int %}
    M140 S{inner}
    M141 S{outer}
    RESPOND MSG="Bed zones set: Inner={inner}°C, Outer={outer}°C"

#########################################################################
# COOLING UTILITY MACRO
#########################################################################

[gcode_macro SPRO_ACTIVE_COOLDOWN]
description: Active cooling using all available fans
gcode:
    {% set TARGET = params.TARGET|default(40)|int %}
    {% set SENSOR = params.SENSOR|default("heater_bed") %}
    
    RESPOND MSG="Active cooling to {TARGET}°C..."
    M106 S255  # Part cooling fan at max
    SET_FAN_SPEED FAN=box_fan SPEED=1.0  # Chamber fan at max
    TEMPERATURE_WAIT SENSOR={SENSOR} MAXIMUM={TARGET}
    M107  # Part cooling off
    SET_FAN_SPEED FAN=box_fan SPEED=0  # Chamber fan off
    RESPOND MSG="Target temperature {TARGET}°C reached"